@using Microsoft.Ajax.Utilities
@using Stuff.Models
@model Stuff.Models.Department[]

@{
    ViewBag.Title = "Подразделения и сотрудники";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var curYear = ViewBag.CurYear;
}

<p>
    <span class="text-danger">@ViewData["ServerError"]</span>
</p>
@if (Model.Any())
{
    <table id="depList" class="table table-bordered no-padding">
        <tr class="bg-primary">
            <th class="min-width">№</th>
            <th class="width-20p">Подразделение</th>
            <th>Руководитель</th>
            <th>Сотрудники</th>
        </tr>
        @{int i = 0;}
        @foreach (Department dep in Model)
{
    i++;
    <tr >
        <th>@i</th>
        <td>@dep.Name</td>
        <td>@dep.Chief.DisplayName</td>
        <td department="@dep.Id" name="depTable"></td>
    </tr>
}
    </table>
}

@section scripts
{

    <script type="text/javascript">
        $(document).ready(function() {
            init();

        });

        function init() {
            $('[name="depTable"]').map(function () {
                var elem = $(this);
                elem.text("Loading...");
                var url = "@Url.Action("EmployeesRestHolidaysTable","Department")?departmentId=" + $(this).attr("department") + "&curYear=@curYear";
                $.ajax({
                    url: url,
                    dataType: 'html',
                    success: function (data) {
                        elem.html(data);
                    }
                });
            });


        }
    </script>

}