@using Microsoft.Ajax.Utilities
@using Stuff.Models
@model Stuff.Models.Department[]

@{
    ViewBag.Title = "Подразделения и сотрудники";
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool userCanEdit = ViewBag.CurUser.UserCanEdit();
}

<p>
    <span class="text-danger">@ViewData["ServerError"]</span>
</p>
@if (Model.Any())
{
    <table id="depList" class="table table-bordered no-padding">
        <tr class="bg-primary">
            <th class="min-width">№</th>
            <th class="width-20p">Подразделение</th>
            <th>Руководитель</th>
            <th>Сотрудники</th>
        </tr>
        @{int i = 0;}
        @foreach (Department dep in Model)
{
    i++;
    <tr>
        <th>@i</th>
        <td>@dep.Name</td>
        <td>@dep.Chief.DisplayName</td>
        <td department="@dep.Id" name="depTable"></td>
    </tr>
}
    </table>
}

@section scripts
{
    <script type="text/javascript">
        $(document).ready(function() { init(); });

        function init() {
            $("[name='delete-emp']").click(deleteEmployee);

            $('[name="depTable"]').map(function () {
                var elem = $(this);
                elem.text("Загрузка...");
                var url = "@Url.Action("EmployeesTable","Department")?departmentId=" + $(this).attr("department")+"&userCanEdit=@userCanEdit";
                var loadCount = 0;
                loadDepartment(loadCount, elem, url);
            });
        }
        function loadDepartment(loadCount, elem, url) {
            $.ajax({
                url: url,
                dataType: 'html',
                success: function (data) {
                    elem.html(data);
                },
                error: function (errorData) {
                    if (loadCount < 3) {
                        loadCount++;
                        setTimeout(loadDepartment(loadCount, elem, url), 1000);
                    } else {
                        elem.html("<span class='alert-danger'>" + errorData.statusText + "</span>");
                    }
                }
            });
        }
        function deleteEmployee() {
            if (!confirm('Вы действительно хотите удалить сотрудника?')) return;

            var id = $(this).attr('empId');
            $.post("@Url.Action("Delete", "Employee")", { id: id }, function() {
                window.location.reload();
            }
            );
        }
    </script>

}