@using Stuff.Helpers
@using Stuff.Models
@using Stuff.Objects
@model Stuff.Models.RecruitCandidate

@{
    ViewBag.Title = "Новый кандидат";
    Layout = "~/Views/Shared/_Editor.cshtml";
    int idVacancy;
    int.TryParse(Request.QueryString["vid"], out idVacancy);
}

@section PanelHead
{
    Новый кандидат
}

@section PanelBody
{
    @*@using (Html.BeginForm("CandidateNew", "Recruit", FormMethod.Post, new { @id = "posForm", @class = "form-horizontal", role = "form" }))
    {*@
<form action='@Url.Action("CandidateNew", "Recruit")?vid=@Request.QueryString["vid"]&returnUrl=@Request.QueryString["ReturnUrl"]' method="post" enctype="multipart/form-data" class="form-horizontal" role="form">
    <div class="form-group">
        <label class="col-lg-2 control-label" for="birthDate">Пол</label>
        <div class="col-lg-2">
            <span class="form-control required-mark">
                @Html.RadioButtonFor(m => m.Male, true) муж&nbsp;&nbsp;&nbsp; @Html.RadioButtonFor(m => m.Male, false) жен
            </span>
            <span class="help-block with-errors"></span>
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-2 control-label" for="fio">ФИО</label>
        <div class="col-lg-3">
            @Html.TextBoxFor(m => m.Surname, new { @class = "form-control required-mark", @id = "surname", placeholder = "Фамилия", required = "required", data_error = "Заполните поле Фамилия" })
            <div class="help-block with-errors"></div>
        </div>
        <div class="col-lg-3">
            @Html.TextBoxFor(m => m.Name, new { @class = "form-control required-mark", @id = "name", placeholder = "Имя", required = "required", data_error = "Заполните поле Имя" })
            <div class="help-block with-errors"></div>
        </div>
        <div class="col-lg-3">
            @Html.TextBoxFor(m => m.Patronymic, new { @class = "form-control", @id = "patronymic", placeholder = "Отчество" })
            <div class="help-block with-errors"></div>
        </div>
        <span class="help-block with-errors"></span>
    </div>
    <div class="form-group">
        <label class="col-lg-2 control-label" for="cameResource">Ресурс</label>
        <div class="col-lg-5">
            @Html.DropDownListFor(m => m.IdCameResource, RecruitCameResource.GetSelectionList(), "--выберите--", new {@class = "form-control required-mark", @id = "cameResource", required = "required", data_error = "Заполните поле Ресурс"})
            <span class="help-block with-errors"></span>
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-2 control-label" for="cameType">Как поступил</label>
        <div class="col-lg-5">
            <div class="form-control required-mark">
                @foreach (RecruitCandidateCameType type in RecruitCandidateCameType.GetList())
                {
                    @Html.RadioButtonFor(m => m.IdCameType, type.Id, new { required = "required" })
                    @:&nbsp;@type.Name
                }
            </div>

            <span class="help-block with-errors"></span>
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-2 control-label" for="birthDate">Дата рождения</label>
        <div class="col-lg-2">
            @Html.TextBoxFor(m => m.BirthDate, new { @class = "form-control", @id = "birthDate", data_mask = "00.00.0000" })
            <span class="help-block with-errors"></span>
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-2 control-label" for="phone">Телефон</label>
        <div class="col-lg-2">
            @Html.TextBoxFor(m => m.Phone, new { @class = "form-control", @id = "phone" })
            <span class="help-block with-errors"></span>
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-2 control-label" for="email">E-mail</label>
        <div class="col-lg-2">
            @Html.TextBoxFor(m => m.Email, new {@class = "form-control", @id = "email"})
            <span class="help-block with-errors"></span>
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-2 control-label">Файл</label>
        <div class="col-lg-5">
            <input id="fileResume" type="file" name="fileResume" />
        </div>
    </div>
    <div class="form-group">
        <div class="col-lg-push-2 col-lg-5">
            @*<button type="submit" class="btn btn-success"><i class="fa fa-save"></i>&nbsp;сохранить</button>*@
            @if (idVacancy > 0)
            {
                <button type="submit" class="btn btn-success" name="append2Vacancy" value="append2Vacancy"><i class="fa fa-save"></i>&nbsp;сохранить</button>
            }
            <a href="@(String.IsNullOrEmpty(Request.QueryString["returnUrl"]) ? Url.Action("Candidates") : Request.QueryString["returnUrl"])" class="btn btn-default"><i class="fa fa-mail-reply"></i> назад</a>
        </div>
    </div>
    <div class="form-group">
        <div class="col-lg-push-2 col-lg-push-2 col-lg-6" id="errorContainer">
            <span class="text-danger">@TempData["error"]</span>
        </div>
    </div>
@*}*@
    </form>
}


@section scripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            $("#birthDate").mask('00.00.0000');
            //$("#dateCame").datepicker({
            //    format: "dd.mm.yyyy",
            //    autoclose: true,
            //    todayBtn: "linked",
            //    language: "ru"
            //});
            $('#surname').keyup(checkCandidateClone);
            $('#name').keyup(checkCandidateClone);
            $('#patronymic').keyup(checkCandidateClone);
        });

        function checkCandidateClone() {
            var surname = $('#surname').val();
            var name = $('#name').val();
            var patronymic = $('#patronymic').val();
            
            if ((surname == null || surname.replace(' ', '') == '') && (name == null || name.replace(' ', '') == '') && (patronymic == null || patronymic.replace(' ', '') == '')) return;

            $.ajax({
                url:'@Url.Action("CheckCandidateClone")',
                method: 'POST',
                data: {surname:surname, name:name, patronymic:patronymic},
                success: function (id) {
                    
                    var $errorContainer = $('#errorContainer');
                    
                    if (id > 0) {
                        $errorContainer.html('<blockquote id="candidateExistsNote" class="alert-danger">Кандидат с таким же именем уже существует в базе <a href="@Url.Action("CandidateCard")?id=' + id + '" target="_blank">открыть карточку</a><button type="submit" class="btn btn-warning" name="appendExistsing2Vacancy" value="appendExistsing2Vacancy" formnovalidate><i class="fa fa-save"></i>&nbsp;добавить к вакансии</button><input id="existsingId" type="hidden" name="existsingId" value="' + id + '" /></blockquote>');
                    } else {
                        $errorContainer.find("#candidateExistsNote").remove();
                    }
                }
            })
        }
    </script>
}
