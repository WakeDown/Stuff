@using System.Configuration
@using Stuff.Models
@using Stuff.Objects
@model Stuff.Models.RecruitVacancy

@{
    ViewBag.Title = "Вакансия №" + Model.Id;
    Layout = "~/Views/Shared/_Editor.cshtml";
    var stateCount = RecruitSelection.GetStateList().Count();
}

@section PanelHead
{
    Вакансия №@Model.Id

@if (ViewBag.CurUser.HasAccess(AdGroup.RecruitManager, AdGroup.RecruitControler))
{
    if (ViewBag.CurUser.HasAccess(AdGroup.RecruitControler) && Model.StateIsActive)
     {
         <button id="delete" class="btn btn-danger btn-xs pull-right"><i class="fa fa-trash"></i> удалить</button>
         <button id="change" class="btn btn-warning btn-xs pull-right" style="margin-right: 5px;"><i class="fa fa-edit"></i> изменить</button>
     }
}
    @*<link rel="stylesheet" type="text/css" href="../../Content/tiny.editor.min.css"/>
    <script src="../../Scripts/tiny.editor.min.js"></script>*@
<link rel="stylesheet" type="text/css" href="../../Content/bootstrap-wysiwyg.css" />
}

@section PanelBody
{
    <div class="row">
        <div class="col-lg-8">
            <div id="vacancyInfo">
                @*<div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Город:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm bold">@Html.LabelFor(m => m, Model.CityName)</div>
                </div>*@
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Филиал:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm bold">@Html.LabelFor(m => m, Model.BranchOfficeName)</div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Подразделение:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm bold">@Html.LabelFor(m => m, Model.DepartmentName)</div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Должность:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm">@Html.LabelFor(m => m, Model.PositionName)</div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Руководитель:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm">@Html.LabelFor(m => m, Model.ChiefName)</div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Руководитель принимающий решение:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm">@Html.LabelFor(m => m, Model.MatcherName)</div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Менеджер по персоналу:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm" id="personalManagerContainer">
                        @Html.LabelFor(m => m, Model.PersonalManagerName)
                    </div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Автор заявки:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm">@Html.LabelFor(m => m, Model.AuthorName)</div>
                </div>
                @*<div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Дата окончания План:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm">
                        <label>@Model.DeadlineDate.ToString("dd.MM.yyyy")</label>
                    </div>
                </div>*@
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Дата окончания Регламент:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm">
                        <label>@(Model.OrderEndDate.HasValue ? Model.OrderEndDate.Value.ToString("dd.MM.yyyy") : "не указана")</label>
                    </div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Дата окончания Заявка:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm">
                        <label>@(Model.ClaimEndDate.HasValue ? Model.ClaimEndDate.Value.ToString("dd.MM.yyyy") : "не указана")</label>
                    </div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Причина возникновения:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm">@Html.LabelFor(m => m, Model.CauseName)</div>
                </div>
                <div class="row pad-t-sm-sm">
                    <div class="col-lg-4 col-sm-12 text-center-sm text-right-lg">Комментарий:</div>
                    <div class="col-lg-8 col-sm-12 text-center-sm" id="commentContainer">@Html.LabelFor(m => m, Model.Comment)</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="nomargin">
                        История
                    </h4>
                </div>
                <div class="panel-body" id="history">
                </div>
            </div>
        </div>
    </div>
    <p>
        <h4>
            Список кандидатов <span id="candidatesCount" class="badge badge-info"></span>
@if (ViewBag.CurUser.HasAccess(AdGroup.RecruitManager, AdGroup.RecruitControler))
{
    if (Model.StateIsActive)
     {
         <button id="addCandidate" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#candidateListModal"><i class="fa fa-plus-circle"></i> добавить из списка</button>
         <a href="@Url.Action("CandidateNew")?vid=@Model.Id&returnUrl=@Request.Url" class="btn btn-primary btn-sm"><i class="fa fa-plus-circle"></i> новый кандидат</a>
     }
}
        </h4>

        <div id="candidatesList"></div>
    </p>

    

    <!-- Modal -->
    <div id="candidateStateResultModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Укажите результат</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-4">
                            <textarea id="stateComment" class="form-control" placeholder="Комментарий" rows="9"></textarea>
                        </div>
                        <div class="col-lg-4">
                            <button id="selectionSetNextState" class="btn btn-success btn-block">Перевести на следущюий этап</button>
                            <button id="selectionSetCurrentState" class="btn btn-warning btn-block">Оставить на текущем этапе</button>
                            <button id="selectionSetCancelState" class="btn btn-danger btn-block">Отклонить</button>
                            <button type="button" class="btn btn-default btn-block" data-dismiss="modal">Отмена</button>
                            <button id="selectionSetAcceptState" class="btn btn-primary btn-block">Утвердить кандидата</button>
                        </div>
                        <div class="col-lg-4">
                            <div id="candidateStateResultHistory"></div>
                        </div>
                    </div>
                </div>
                @*<div class="modal-footer">

                    </div>*@
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="selectionHistoryModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">История кандидата для вакансии №@Model.Id</h4>
                    <div>@Model.BranchOfficeName<br/>@Model.PositionName<br/><small>@Model.DepartmentName</small>
                    </div>
                    <div>Кандидат - <strong id="historyCandidateName"></strong>
                    </div>
                </div>
                <div class="modal-body">
                    <p id="selectionHistoryList"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="candidateListModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    @*<button type="button" class="close" data-dismiss="modal">&times;</button>*@
                    <div>
                        <h4 class="modal-title">
                            Список кандидатов - всего <span id="candidatesSelectionTotalCount" class="badge"></span>
                            <button type="button" class="btn btn-default pull-right" data-dismiss="modal">Отмена</button>
                            <button name="addSelectedCandidates" class="btn btn-success pull-right">Добавить выбранные <span name="selectedCandidatesSelection" class="badge"></span></button>
                        </h4>
                    </div>
                </div>
                <div class="modal-body">
                    <p id="candidateList"></p>
                </div>
                <div class="modal-footer">
                    <button name="addSelectedCandidates" class="btn btn-success">Добавить выбранные <span name="selectedCandidatesSelection" class="badge"></span></button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="vacancyChangeListModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    @*<button type="button" class="close" data-dismiss="modal">&times;</button>*@
                    <div>
                        <h4 class="modal-title">
                            Список вакансий - всего <span id="vacancySelectionTotalCount" class="badge"></span>
                            <button type="button" class="btn btn-default pull-right" data-dismiss="modal">Отмена</button>
                            <button name="addSelectedVacancies" class="btn btn-success pull-right">Перенести кандидата на отмеченные <span name="selectedVacanciesSelection" class="badge"></span></button>
                        </h4>
                        <div>Кандидат - <strong id="vacancyChangeCandidateName"></strong>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                    <p id="vacancyChangeList"></p>
                </div>
                <div class="modal-footer">
                    <button name="addSelectedVacancies" class="btn btn-success">Перенести кандидата на отмеченные <span name="selectedVacanciesSelection" class="badge"></span></button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                </div>
            </div>
        </div>
    </div>

<div id="questionFormMessageModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">
                    Сообщение
                </h4>
            </div>
            <div class="modal-body form-horizontal">
                <div class="form-group">
                    <label for="questionFormEmail" class="col-lg-2 control-label">Кому</label>
                    <div class="col-lg-10">
                        <input type="email" class="form-control" id="questionFormEmail" name="email" placeholder="example@outlook.ru" value="">
                    </div>
                </div>
                <div class="form-group">
                    <label for="questionFormSubject" class="col-lg-2 control-label">Тема</label>
                    <div class="col-lg-10">
                        <input type="text" class="form-control" id="questionFormSubject" name="subject" placeholder="Тема" value="">
                    </div>
                </div>
                <div class="form-group">
                    <label for="questionFormMessageContainer" class="col-lg-2 control-label">Сообщение</label>
                    <div class="col-lg-10">
                        <textarea class="form-control" rows="8" name="message" id="questionFormMessageContainer"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="form-group">
                    <div class="col-lg-push-2 col-lg-10">
                        <button type="button" class="btn btn-success" id="sendCameMail">Отправить письмо</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>
}

@section scripts
{
    <script src="../../Scripts/bootstrap-wysiwyg.js"></script>
    <script type="text/javascript">
        function loadVacancySelectionList() {
            var $cont = $('#vacancyChangeList');
            var slid = $('#vacancyChangeListModal').attr('slid');
            //var curvid =  $('#vacancyChangeListModal').attr('curvid');
            $.ajax({ url: '@Url.Action("VacancySelection")', method: 'GET', success: function(html) { $cont.html(html); } });
            $('[name="addSelectedVacancies"]').click(function() {
                var $this = $(this);
                showSpinnerAppendAndDisable($this);
                @*переменная selectedCandidateResume находится в view CandidatesSelection*@
                $.ajax({
                    url: '@Url.Action("ChangeVacancy4Candidate")',
                    method: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    data: JSON.stringify({ idSelection: slid, idVacancies: selectedVacancies }),
                    success: function() {
                        loadCandidatesList();
                        selectedVacancies = [];
                        hideSpinnerAndEnabled($this);
                    },
                    error:
                        function() {
                            alert('Ошибка при добавлении списка кандидатов к вакансии! Восможно данные не были сохранены!');
                            loadCandidatesList();
                            selectedVacancies = [];
                            hideSpinnerAndEnabled($this);
                        }
                });
                $('#vacancyChangeListModal').modal('hide');
            });
        }

        function loadCandidateSelectionList() {
            var $cont = $('#candidateList');
            $.ajax({ url: '@Url.Action("CandidatesSelection")', method: 'GET', success: function(html) { $cont.html(html); } });
            $('[name="addSelectedCandidates"]').click(function() {
                var $this = $(this);
                showSpinnerAppendAndDisable($this);
                @*переменная selectedCandidateResume находится в view CandidatesSelection*@
                $.ajax({
                    url: '@Url.Action("AppendCandidates2Vacancy")',
                    method: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    data: JSON.stringify({ idVacancy: @Model.Id, idCandidates: selectedCandidateResume }),
                    success: function() {
                        loadCandidatesList();
                        selectedCandidateResume = [];
                        hideSpinnerAndEnabled($this);
                    },
                    error:
                        function() {
                            alert('Ошибка при добавлении списка кандидатов к вакансии! Восможно данные не были сохранены!');
                            loadCandidatesList();
                            selectedCandidateResume = [];
                            hideSpinnerAndEnabled($this);
                        }
                });
                $('#candidateListModal').modal('hide');
            });
        }

        function loadCandidatesList() {
            var $cont = $('#candidatesList');
            var $candidatesCount = $('#candidatesCount');
            $cont.empty();
            $candidatesCount.empty();
            $.ajax({
                url: '@Url.Action("GetVacancyCandadateList")',
                method: 'POST',
                data: { id: @Model.Id },
                success: function(data) {
                    $cont.empty();
                    $candidatesCount.text(data.totalCount);
                    var $table = $('<table id="tblVacancyCandidateList" class="table table-bordered table-striped table-hover"></table>');
                    $table.append('<thead><tr class="bg-primary">' +
                        '<th class="min-width text-nowrap">ID</th>' +
                        '<th>ФИО</th>' +
                        '<th>Пол</th>' +
                        '<th>Возраст</th>' +
                        '<th>Телефон</th>' +
                        '<th>E-mail</th>' +
                        '<th style="width:40%">Состояние</th>' +
                        '<th class="min-width"></th>' +
                        '</tr></thead>');
                    $cont.append($table);
                    if (data.list.length > 0) {
                        for (var i = 0; i < data.list.length; i++) {
                            var item = data.list[i];
                            $table.append(getCandidateListRow(item));
                        }
                        //$table.tablesorter({
                        //    sortList: [[1,1]],
                        //    headers: { 7: { sorter: false} }
                        //});

                    } else {
                        $table.append('<tr><td>пусто</td></tr>');
                    }

                    $('#selectionSetNextState').click(selectionSetNextState);
                    $('#selectionSetCancelState').click(selectionSetCancelState);
                    $('#selectionSetAcceptState').click(selectionSetAcceptState);
                    $('#selectionSetCurrentState').click(selectionSetCurrentState);
                },
                error: function() {
                    alert('Ошибка при загрузке списка кандидатов');
                }
            });
        }

        function showSelectionHistory() {
            var $this = $(this);
            var id = $this.attr('slid');
            var cname = $this.attr('cname');
            $('#selectionHistoryModal').modal('show');
            var $cont = $('#selectionHistoryList');
            $cont.empty();
            $('#historyCandidateName').text('');
            $('#historyCandidateName').text(cname);
            $.ajax({
                url: '@Url.Action("SelectionHistory")?id=' + id,
                mode: 'GET',
                success: function(html) {
                    $cont.html(html);
                },
                error: function() {
                    alert('Ошибка при загрузке истории!');
                }
            });
        }

        function fillFileList(id, slid, $row) {
            //$row.find('#sel-files-' + id);// $('#sel-files-' + id);
            var $cont = $row.find('#sel-files-' + slid);
            $.ajax({
                url: '@Url.Action("GetCandidateFileList")',
                method: 'POST',
                data: { id: id },
                success: function(data) {
                    if (data.length > 0) {
                        var showNum = data.length > 1;
                        for (var i = 0; i < data.length; i++) {
                            var item = data[i];
                            if (item.Sid) {
                                var elem = '<div><a class="text-danger btn-sm" href="@Url.Action("GetCandidateFile")?sid=' + item.Sid + '" target="_blank">файл резюме ' + (showNum ? + i+1 : '') + '</a></div>';
                                $cont.append(elem);
                            }
                        }
                    }
                },
                error: function() {
                    alert('Ошибка при загрузке файлов резюме!');
                }
            });
        }

        function getCandidateListRow(item) {
            var $row = $('<tr id="sel-' + item.Id + '" slid="' + item.Id + '" class="' + (item.StateIsAccept == true ? ' selected' : '') + '">' +
                '<th>' + item.Candidate.Id + '</th>' +
                '<td><a target="_blank" href="@Url.Action("CandidateCard")?id=' + item.Candidate.Id + '">' + item.Candidate.Surname + ' ' + item.Candidate.Name + ' ' + (item.Candidate.Patronymic == null ? '' : item.Candidate.Patronymic) + '</a>' +
                (item.CameTypeName == null ? '' : '<br /><small>' + item.CameTypeName + '</small>') +
                @*(item.Candidate.FileSid == null || item.Candidate.FileSid == '' ? '' : '<br />' +
                    '<a class="text-danger btn-sm" href="@Url.Action("GetCandidateFile")?sid=' + item.Candidate.FileSid + '" target="_blank">файл резюме</a>')+*@
                    '<div id="sel-files-' + item.Id + '"></div>' +
                '</td>' +
                '<td>' + (item.Candidate.MaleStr == null ? '' : item.Candidate.MaleStr) + '</td>' +
                '<td>' + (item.Candidate.Age == null ? '' : item.Candidate.Age) + '</td>' +
                '<td>' + (item.Candidate.Phone == null ? '' : item.Candidate.Phone) + '</td>' +
                '<td>' + (item.Candidate.Email == null ? '' : item.Candidate.Email) + '</td>' +
                '<td>' +
                '<div class="row">' +
                '<div class="col-lg-8">' +
                '<strong>' + item.StateName + '</strong>' +
                '<br /><small>' + item.StateChangeDateStr + ' - ' + item.StateChangerName + '</small>' +
                '<br /><small>' + (item.StateDescr != null ? item.StateDescr : '') + '</small>' +
                '</div>' +
                '<div class="col-lg-4">' +
                '<div class="pull-right">' + getstateIndicate(item.FullStateCount, item.StateIsCancel) + '</div>' +
                '<div><button name="sel-history" slid="' + item.Id + '" cname="' + item.Candidate.DisplayName + '" class="btn btn-link pull-right">показать историю</button></div>' +
                '</div>' +
                '</div>' +
                '</td>' +
                '<td>'
                @if (ViewBag.CurUser.HasAccess(AdGroup.RecruitManager, AdGroup.RecruitControler))
                {
                    <text>
                    + (item.IdNextState != null && item.IdNextState > 0 && item.ShowNextStateButton == true ?
                        '<button name="selectionSetState" nstnm="' + item.NextStateButtonName + '" cstid="' + item.IdState + '" slid="' + item.Id + '" nstid="' + item.IdNextState + '" class="btn btn-warning btn-sm btn-block">Изменить статус</button>' +
                        '<button name="changeVac" slid="' + item.Id + '" class="btn btn-danger btn-sm btn-block" cname="' + item.Candidate.DisplayName + '">На другую вакансию</button>'
                        //+ '<button name="create-link" class="btn btn-info btn-sm btn-block pull-right" slid="' + item.Id + '" eml="' + item.Candidate.Email + '">Приглашение</button>'
                        : '') +
                    (item.StateIsAccept == true ? '<a href="@Url.Action("New", "Employee")?sex=' + item.Candidate.Male + '&sur=' + item.Candidate.Surname + '&nam=' + item.Candidate.Name + '&pat=' + item.Candidate.Patronymic + '&bdt=' + item.Candidate.BirthDateQueStr + '&cit=' + item.Vacancy.IdCity + '" name="createEmployee" slid="' + item.Id + '" curvid="@Model.Id" class="btn btn-success btn-lg btn-block">В новобранца</a>' : '')
                     +
                    (item.StateIsAccept == false && item.StateIsCancel == true ?
                    '<button name="restoreSel" slid="' + item.Id + '" class="btn btn-success btn-sm btn-block" cname="' + item.Candidate.DisplayName + '">Восстановить</button>'
                    : '')
                    </text>
                }
                + '</td>' +
                '</tr>');

            fillFileList(item.Candidate.Id, item.Id, $row);

            $('[name="sel-history"]', $row).click(showSelectionHistory);

            $row.find('[name="restoreSel"]').click(function() {
                if (!confirm('Вы дествительно хотите восстановить кандидата?')) return;
                var $this = $(this);
                showSpinnerAppendAndDisable($this);

                var slid = $this.attr('slid');
                $.ajax({
                    url: '@Url.Action("SelectionRestore")',
                    method: 'POST',
                    data: { id: slid },
                    success: function(data) {
                        var $row = $('#sel-' + slid);
                        $row.replaceWith(getCandidateListRow(data));
                        hideSpinnerAndEnabled($this);
                    },
                    error: function() {
                        alert('Ошибка при восстановлении кандидата!');
                        hideSpinnerAndEnabled($this);
                    }
                });
            });

            $row.find('[name="changeVac"]').click(function() {
                var $this = $(this);
                var slid = $this.attr('slid');
                var cname = $this.attr('cname');
                var curvid = $this.attr('curvid');
                $('#vacancyChangeCandidateName').text('');
                $('#vacancyChangeCandidateName').text(cname);

                var $modal = $('#vacancyChangeListModal');
                $modal.attr('slid', slid);
                $modal.attr('curvid', curvid);
                $modal.modal('show');
            });

            $('[name="selectionSetState"]', $row).click(function() {
                var $this = $(this);
                var slid = $this.attr('slid');
                var nstid = $this.attr('nstid');
                var cstid = $this.attr('cstid');
                var nstnm = $this.attr('nstnm');
                var $modal = $('#candidateStateResultModal');
                $modal.attr('slid', slid);
                $modal.attr('nstid', nstid);
                $modal.attr('cstid', cstid);
                $('#selectionSetNextState').text(nstnm);
                $modal.modal('show');
            });

            $('[name="create-link"]', $row).click(function() {
                var $this = $(this);
                var slid = $this.attr('slid');
                var email = $this.attr('eml');
                if (!email) {
                    email = '';
                }
                $.ajax({
                    url: '@Url.Action("CreateQuestionLink")',
                    method: 'POST',
                    data: { idSelection: slid },
                    success: function(data) {
                        var sid = data.sid;
                        var link = '@ConfigurationManager.AppSettings["PortalUrl"]@Url.Action("Index", "RecruitQuestion")?sid=' + sid;
                        var msg = 'Добрый день.<br />Приглашаю вас на собеседование .<br />Так же прошу вас заполнить анкету по ссылке ниже.<br />Ссылка на анкету - <a href="' + link + '">' + link + '</a>';
                        var $cont = $('#questionFormMessageContainer');
                        $cont.wysihtml5();
                        $cont.val(msg);
                        $('#questionFormSubject').val('Приглашение на собеседование');
                        $('#questionFormEmail').val(email);
                        $('#questionFormMessageModal').modal('show');

                    },
                    error: function() {
                        alert('Ошибка при генерации анкеты!');
                    }
                });
            });

            return $row;
        }

        function getstateIndicate(curStateNum, isCancel) {
            var stateCount = @stateCount;
            var result = '<div class="stateIndicateContainer">';

            for (var i = 1; i <= stateCount; i++) {
                result += '<div class="state-indicate-item ' + (i <= curStateNum ? 'full' : 'empty') + '' + (isCancel == true && i == curStateNum ? ' cancel' : '') + '">&nbsp;&nbsp;</div>';
            }
            result += '</div>';

            return result;
        }

        function selectionSetCurrentState(e) {

            e.stopPropagation();
            var $this = $(this);
            showSpinnerAppendAndDisable($this);
            var $modal = $('#candidateStateResultModal');
            var slid = $modal.attr('slid');
            var cstid = $modal.attr('cstid');
            var descr = $('#stateComment').val();
            if (descr == null || descr == '') {
                alert('Укажите причину!');
                $('#stateComment').focus();
                return;
            }

            $.ajax({
                url: '@Url.Action("SelectionSetNextState")',
                method: 'POST',
                data: { id: slid, idState: cstid, descr: descr },
                success: function(data) {
                    var $row = $('#sel-' + slid);
                    $row.replaceWith(getCandidateListRow(data));
                    $modal.modal('hide');
                    hideSpinnerAndEnabled($this);
                },
                error: function() {
                    alert('Ошибка при именении статуса кандидата! Возможно изменения не были сохранены!');
                    hideSpinnerAndEnabled($this);
                }
            });
        }

        function selectionSetAcceptState(e) {
            e.stopPropagation();
            var $this = $(this);
            showSpinnerAppendAndDisable($this);
            var $modal = $('#candidateStateResultModal');
            var slid = $modal.attr('slid');
            var descr = $('#stateComment').val();

            if (!confirm('Вы уверены что хотите утвердить данного кандидата?')) return;

            $.ajax({
                url: '@Url.Action("SelectionSetChiefAcceptState")',
                method: 'POST',
                data: { id: slid, descr: descr },
                success: function(data) {
                    var $row = $('#sel-' + slid);
                    $row.replaceWith(getCandidateListRow(data));
                    $modal.modal('hide');
                    hideSpinnerAndEnabled($this);
                    //var $row = $('#sel-' + slid);
                    //$row.replaceWith(getCandidateListRow(data));
                    //$modal.modal('hide');

                },
                error: function() {
                    alert('Ошибка при именении статуса кандидата! Возможно изменения не были сохранены!');
                    hideSpinnerAndEnabled($this);
                }
            });

            @*if (!confirm('После утверждения кандидата остальным кандидатам будет присвоен статус Отклонено и вакансия будет переведена в статус Завершено! Вы уверены что хотите утвердить данного кандидата?')) return;


            $.ajax({
                url: '@Url.Action("SelectionSetAcceptState")',
                method: 'POST',
                data: { id: slid, descr: descr },
                success: function(data) {
                    window.location.reload();
                    //var $row = $('#sel-' + slid);
                    //$row.replaceWith(getCandidateListRow(data));
                    //$modal.modal('hide');

                },
                error: function() {
                    alert('Ошибка при именении статуса кандидата! Возможно изменения не были сохранены!');
                    hideSpinnerAndEnabled($this);
                }
            });*@
        }

        function selectionSetCancelState(e) {
            e.stopPropagation();
            var $this = $(this);
            showSpinnerAppendAndDisable($this);
            var $modal = $('#candidateStateResultModal');
            var slid = $modal.attr('slid');
            var descr = $('#stateComment').val();

            if (descr == null || descr == '') {
                alert('Укажите причину отклонения!');
                $('#stateComment').focus();
                return;
            }

            $.ajax({
                url: '@Url.Action("SelectionSetCancelState")',
                method: 'POST',
                data: { id: slid, descr: descr },
                success: function(data) {
                    var $row = $('#sel-' + slid);
                    $row.replaceWith(getCandidateListRow(data));
                    $modal.modal('hide');
                    hideSpinnerAndEnabled($this);
                },
                error: function() {
                    alert('Ошибка при именении статуса кандидата! Возможно изменения не были сохранены!');
                    hideSpinnerAndEnabled($this);
                }
            });
        }

        function selectionSetNextState(e) {
            e.stopPropagation();
            var $this = $(this);
            showSpinnerAppendAndDisable($this);
            var $modal = $('#candidateStateResultModal');
            var slid = $modal.attr('slid');
            var nstid = $modal.attr('nstid');
            var descr = $('#stateComment').val();

            $.ajax({
                url: '@Url.Action("SelectionSetNextState")',
                method: 'POST',
                data: { id: slid, idState: nstid, descr: descr },
                success: function(data) {
                    if (data.StateIsAccept != true) {
                        var $row = $('#sel-' + slid);
                        $row.replaceWith(getCandidateListRow(data));
                        $modal.modal('hide');
                        hideSpinnerAndEnabled($this);
                    } else {
                        window.location.reload();
                    }
                },
                error: function() {
                    alert('Ошибка при именении статуса кандидата! Возможно изменения не были сохранены!');
                    hideSpinnerAndEnabled($this);
                }
            });
        }

        function loadHistory() {
            var $cont = $('#history');

            $.ajax({
                url: '@Url.Action("GetVacancyHistory")',
                method: 'POST',
                data: { id: @Model.Id, full: false },
                success: function(data) {
                    $cont.empty();

                    if (data.list.length > 0) {
                        for (var i = 0; i < data.list.length; i++) {
                            var item = data.list[i];
                            var cell = '<div class="history-item"><strong>' + item.StateName + '</strong><br /><small>' + item.DateCreateStr + ' - ' + item.CreatorName + '</small></div>';
                            $cont.append(cell);

                        }

                        if (data.totalCount > data.list.length) {
                            $cont.append('<button id="historyMore" class="btn btn-default btn-xs">еще...(' + (data.totalCount - data.list.length) + ')</button>');
                            $('#historyMore').click(function() {
                                $.ajax({
                                    url: '@Url.Action("GetVacancyHistory")',
                                    method: 'POST',
                                    data: { id: @Model.Id, full: true },
                                    success: function(data) {
                                        $cont.empty();
                                        if (data.list.length > 0) {
                                            for (var i = 0; i <= data.list.length; i++) {
                                                var item = data.list[i];
                                                var cell = '<div class="history-item"><strong>' + item.StateName + '</strong><br /><small>' + item.DateCreateStr + ' - ' + item.CreatorName + '</small></div>';
                                                $cont.append(cell);
                                            }
                                        }

                                    },
                                    error: function() {
                                        alert('Ошибка при загрузке истории!');
                                    }
                                });
                            });
                        }
                    }

                },
                error: function() {
                    alert('Ошибка при загрузке истории!');
                }
            });
        }

        function loadCandidateStateResultHistory() {
            var $this = $(this);
            var $modal = $('#candidateStateResultModal');
            var slid = $modal.attr('slid');
            var $cont = $('#candidateStateResultHistory');
            $cont.empty();
            $.ajax({
                url: '@Url.Action("SelectionTinyHistory")?id=' + slid,
                mode: 'GET',
                success: function(html) {
                    $cont.html(html);
                },
                error: function() {
                    alert('Ошибка при загрузке истории!');
                }
            });
        }

        $(function() {
            loadHistory();
            loadCandidatesList();

            $('#vacancyChangeListModal').on('shown.bs.modal', function() {
                loadVacancySelectionList();
            });

            $('#candidateListModal').on('shown.bs.modal', function() {
                loadCandidateSelectionList();
            });

            $('#candidateStateResultModal').on('shown.bs.modal', function() {
                $('#stateComment').val('');
                loadCandidateStateResultHistory();
            });

            $('#change').click(function() {
                var $this = $(this);
                showSpinnerAppendAndDisable($this);
                var $btnChange = $('#change');
                var $btnSave = $('<button id="save" class="btn btn-success btn-xs pull-right"><i class="fa fa-save"></i> сохранить</button>');
                $btnSave.click(saveVacancy);
                $btnChange.replaceWith($btnSave);

                var $cont = $('#personalManagerContainer');
                $.ajax({
                    url: '@Url.Action("GetPersonalManagerList")',
                    method: 'POST',
                    success: function(data) {
                        if (data.length > 0) {
                            $cont.empty();
                            var $select = $('<select id="personalManager" class="input-sm form-control"></select>');
                            $cont.append($select);
                            var optionNull = '<option value="">--выберите--</option>';
                            $select.append(optionNull);
                            for (var i = 0; i <= data.length; i++) {
                                var item = data[i];
                                var option = '<option value="' + item.Key + '">' + item.Value + '</option>';
                                $select.append(option);
                            }
                            $select.val('@Model.PersonalManagerSid');
                        }
                    },
                    error: function() {
                        alert('Ошибка при редактировании!');
                    }
                });

                var $contComment = $('#commentContainer');
                $contComment.empty();
                var $textarea = $('<textarea id="comment" class="input-sm form-control" rows="2"></textarea>');
                $contComment.append($textarea);
                $textarea.val('@Html.Raw(Model.Comment)');
            });

            $('#delete').click(function() {
                var $this = $(this);
                showSpinnerAppendAndDisable($this);
                if (!confirm('Вы уверены что хотите удалить вакансию?')) return;
                $.ajax({
                    url: '@Url.Action("VacancyDelete")',
                    method: 'POST',
                    data: { id: @Model.Id },
                    success: function() {
                        window.location = '@Url.Action("Index")';
                    },
                    error: function() {
                        alert('Ошибка при удалении. Удаление не выполнено!');
                        hideSpinnerAndEnabled($this);
                    }
                });
            });

            $('#sendCameMail').click(function() {

                var mail = $('#questionFormEmail').val();
                var subj = $('#questionFormSubject').val();
                var text = $('#questionFormMessageContainer').val();

                $.ajax({
                    url: '@Url.Action("SendCameMail")',
                    method: 'POST',
                    data: { mail: mail, text: text, subj: subj },
                    success: function(data) {
                        if (data.error) {
                            alert('Возможно письмо не было отправлено! Ошибка - ' + data.error);
                        } else {
                            $('#questionFormMessageModal').modal('hide');
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(xhr.responseText);
                    }
                });
            });
        });

        function saveVacancy() {
            var $this = $(this);
            showSpinnerAppendAndDisable($this);
            var pesrManager = $('#personalManager').val();
            var comment = $('#comment').val();
            $.ajax({
                url: '@Url.Action("ChangeVacancy")',
                method: 'POST',
                data: { id: @Model.Id, personalManagerSid: pesrManager, comment: comment },
                success: function() {
                    window.location.reload();
                },
                error: function() {
                    alert('Ошибка при сохранении. Возможно данные не были сохранены!');
                    hideSpinnerAndEnabled($this);
                }
            });
        }
    </script>
}
);